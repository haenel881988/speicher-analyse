# Lessons Learned

> **PFLICHT:** JEDER Fehler wird hier dokumentiert, egal wie klein. Fehler dürfen NIEMALS ein zweites Mal auftreten.
> **Verwaltung:** Die KI verwaltet diese Datei, ihre Inhalte und Unterverzeichnisse eigenständig — keine Obergrenze für Einträge.
> **Struktur:** Einträge sind hierarchisch nach Kategorie und chronologisch innerhalb jeder Kategorie sortiert. Originale Nummern (#) bleiben erhalten für Rückverfolgbarkeit.

---

## Allgemein

| # | Datum | Beschreibung |
|---|-------|-------------|
| 2 | 2026-02-10 | **Session-Save im before-quit muss synchron sein** - Electrons `before-quit` wartet NICHT auf async Operationen. Lösung: `zlib.gzipSync()` + `fs.writeFileSync()`. Lehre: Electron Lifecycle-Events sind synchron — für Cleanup immer synchrone APIs verwenden. |
| 4 | 2026-02-10 | **Node.js Buffer.buffer enthält Pool-Daten** - `buffer.buffer` ist der unterliegende ArrayBuffer des GESAMTEN Pools. `new Uint8Array(buffer.buffer)` enthält Müll-Daten. Lösung: `.slice(buffer.byteOffset, buffer.byteOffset + buffer.byteLength)`. |
| 5 | 2026-02-11 | **Electron Admin-Elevation: Single-Instance Lock Race Condition** - `app.quit()` ist ASYNC, `requestSingleInstanceLock()` Race Condition. Lösung: `releaseSingleInstanceLock()` VOR Spawn + `app.exit(0)` statt `app.quit()` + `execFileAsync` statt `execAsync`. |
| 7 | 2026-02-16 | **Bei User-Fehlermeldung ganzheitlich prüfen** - NIEMALS nur den gemeldeten Fall fixen. IMMER prüfen ob weitere Funktionen betroffen sind. Der User darf NIEMALS zweimal auf dasselbe Problem hinweisen. |
| 17 | 2026-02-17 | **Log-Dateien ohne Rotation** - 26 Log-Dateien in docs/logs/, kein automatisches Aufräumen. Fix: Beim App-Start älteste Logs über Maximum (20) löschen. |
| 18 | 2026-02-17 | **Bug-Drift durch oberflächliche Analyse** - Fixes eingeführt die neue Bugs erzeugen (z.B. detect_os() zeigt "Windows" in Modell-Spalte). Lehre: JEDE Änderung muss den vollständigen Datenfluss Frontend→Backend→Frontend prüfen. NIE nur eine Seite ändern. |
| 24 | 2026-02-17 | **Autostart: Substring-Match trifft RunOnce** - `locationLabel.contains("HKCU\\Run")` matcht auch "HKCU\RunOnce". Spezifischere Patterns MÜSSEN zuerst geprüft werden. Fix: RunOnce-Check VOR Run-Check in if/else-Kette. |
| 30 | 2026-02-17 | **Umlaute in PowerShell-Strings** - `get_privacy_recommendations` nutzte ae/oe/ue statt ä/ö/ü. Lehre: Rust-Quellcode ist UTF-8, PowerShell-Strings in `r#"..."#` können echte Umlaute enthalten. |
| 33 | 2026-02-17 | **correlate_software: Falscher Feldname** - Backend erwartete `displayName`, aber `audit_software` liefert `name`. Fix: Fallback `.get("displayName").or_else(|| .get("name"))`. Lehre: Bei Funktionen die Daten von anderen Funktionen erhalten, IMMER die Feldnamen beider Seiten prüfen. |
| 35 | 2026-02-17 | **get_system_profile: partitions=0** - Disk-Partitionsanzahl war hart auf 0 kodiert. Fix: `Get-Disk` pro PhysicalDisk abfragen für `NumberOfPartitions`. |
| 42 | 2026-02-17 | **uninstall_bloatware: False Success** - `Ok(success: true)` auch wenn `packageFullName` fehlte (nichts deinstalliert). Fix: Fehler zurückgeben wenn Pflichtfeld fehlt. Lehre: Destruktive Operationen MÜSSEN bei fehlendem Input Err() zurückgeben, nie stillschweigend "Erfolg" melden. |
| 45 | 2026-02-17 | **get_update_history: Kein try/catch** - COM-Objekt-Aufruf ohne Fehlerbehandlung. Fix: try/catch mit Fallback auf leeres Array (konsistent mit check_windows_updates). |
| 46 | 2026-02-17 | **deep_search_start: use_regex ignoriert** - Parameter `_use_regex` mit Underscore-Prefix → nie verwendet. Fix: Implementiert als `-match` (Regex) vs. `-like` (Wildcard) Umschaltung in PowerShell-Script. |
| 48 | 2026-02-17 | **terminal_create: Spawn-Fehler = Ok statt Err** - Bei fehlgeschlagenem Prozess-Start wurde `Ok({"id": null})` statt `Err()` zurückgegeben. Frontend musste `id == null` prüfen statt normaler Fehlerbehandlung. Fix: `Err()` zurückgeben. |
| 49 | 2026-02-17 | **ps.rs: UTF-8 Panic bei Byte-Slicing** - `&trimmed[..120]` und `&output[..200]` sind Byte-Indizes. Bei Multi-Byte UTF-8 (Umlaute=2 Bytes) kann der Index mitten in einem Zeichen landen → `panic!("byte index is not a char boundary")`. Fix: `is_char_boundary()` Loop findet sicheren Schneidepunkt. Lehre: NIEMALS `&str[..n]` mit hartem Byte-Index — immer Char-Boundary prüfen. |
| 52 | 2026-02-17 | **scan.rs: normalize_dir_key ohne Case-Normalisierung** - Windows-Dateisystem ist case-insensitive. `C:\Users` und `c:\users` sind derselbe Pfad. Ohne Lowercase-Normalisierung schlägt der Verzeichnis-Index-Lookup fehl. Fix: `.to_lowercase()` in `normalize_dir_key()` und `build_dir_index()`. |
| 53 | 2026-02-17 | **scan.rs: file_count inkonsistent** - Root-Knoten gab `own_file_count` zurück, Kinder gaben `total_file_count` — je nach Ebene unterschiedliche Semantik. Fix: Einheitlich `total_file_count` für alle Knoten. |
| 61 | 2026-02-17 | **Backend-Event ohne Frontend-Listener** - `lib.rs` emittierte `"menu-action"` für den "Über"-Menüeintrag, aber die Bridge hatte keinen Listener und app.js keinen Handler. Klick ging ins Leere. Fix: `onMenuAction` in Bridge + Handler in app.js. Lehre: Bei jedem `app.emit()` im Backend prüfen ob ein Listener in der Bridge existiert. |
| 65 | 2026-02-18 | **Frontend-Backend Feldnamen-Mismatch bei 3 Funktionen** - **Betroffen:** (1) `file_properties` gibt `isDir` zurück, Frontend (`file-manager.js:152,159,168`) prüft `props.isDirectory` → Ordner werden IMMER als "Datei" angezeigt, Ordnergrösse wird nie berechnet. (2) `file_properties` gibt `readOnly` (camelCase) zurück, Frontend (`file-manager.js:164`) prüft `props.readonly` (lowercase) → Schreibschutz zeigt IMMER "Nein". (3) `calculate_folder_size` gibt `totalSize`/`fileCount`/`dirCount` zurück, Frontend (`file-manager.js:172-173`) liest `result.size`/`result.files`/`result.dirs` → Ordnergrösse zeigt nie korrekte Werte. **Ursache:** Feldnamen aus PowerShell (`ConvertTo-Json`) werden 1:1 durchgereicht, Frontend wurde mit anderen Namen geschrieben. Kein Schema-Vertrag zwischen Backend und Frontend. **Lehre:** Bei JEDEM neuen API-Aufruf: Rückgabestruktur in `commands.rs` lesen und mit Frontend-Zugriff vergleichen. Erweitert Lesson #33 (correlate_software Feldname) — dasselbe Muster, drei neue Instanzen. |
| 66 | 2026-02-18 | **Backend gibt Objekt zurück, Frontend erwartet Array** - **Betroffen:** `delete_to_trash`, `delete_permanent`, `file_copy`, `file_move` geben alle `json!({ "success": true })` zurück (einzelnes Objekt). Frontend (`file-manager.js:50,79,108`) ruft `results.filter(r => !r.success)` darauf auf → **TypeError: results.filter is not a function**. Papierkorb-Löschen, permanentes Löschen, Kopieren und Einfügen crashen ALLE. **Ursache:** Electron-Version gab vermutlich ein Array mit Einzelergebnis pro Datei zurück, Tauri-Version gibt zusammengefasstes Objekt zurück. Frontend wurde nicht angepasst. **Lehre:** Bei Migration JEDE Return-Shape prüfen, nicht nur den Happy Path. `.filter()` auf einem Nicht-Array ist ein sofortiger Crash. |
| 67 | 2026-02-18 | **delete_to_trash: DeleteFile() funktioniert nicht für Ordner** - `[Microsoft.VisualBasic.FileIO.FileSystem]::DeleteFile()` (`commands.rs:328`) ist die VB.NET-Methode NUR für Dateien. Für Ordner gibt es `DeleteDirectory()`. Wenn ein User einen Ordner per Rechtsklick → "In Papierkorb" löschen will, schlägt die Operation fehl. **Lösung:** Pfad prüfen — `Test-Path -PathType Container` → `DeleteDirectory()` verwenden, sonst `DeleteFile()`. **Lehre:** .NET Framework-Methoden haben getrennte APIs für Dateien und Verzeichnisse. IMMER die Dokumentation prüfen. |
| 68 | 2026-02-18 | **file_copy: tokio::fs::copy() kopiert keine Ordner** - `tokio::fs::copy()` (`commands.rs:383`) kopiert nur einzelne Dateien. Für Verzeichnisse gibt es kein `tokio::fs::copy_dir()`. Wenn ein User einen Ordner ausschneidet/kopiert und einfügt, schlägt das Kopieren fehl. `file_move` nutzt `tokio::fs::rename()` das auch für Ordner funktioniert — aber nur auf demselben Laufwerk. **Lösung:** Für Ordner-Kopie: `walkdir` oder rekursive Implementierung. Für Cross-Volume-Move: Copy + Delete. **Lehre:** Dateisystem-Operationen die auf Dateien funktionieren, funktionieren NICHT automatisch auf Verzeichnisse. Immer beides testen. |
| 71 | 2026-02-18 | **GPU-Cache-Locking in Electron** (Memory-Migration, Electron-Ära) - Electron + Tray = IMMER `app.requestSingleInstanceLock()` verwenden, um GPU-Cache-Konflikte zu verhindern. GPU-Cache "Zugriff verweigert" = NICHT harmlos! Bedeutet: Eine andere Instanz hat den Cache gelockt → eingefrorene UI. `disableHardwareAcceleration()` fixt das NICHT (hilft nur bei Treiber-Problemen). `--disable-gpu-shader-disk-cache` verhindert GPU-Cache-File-Locking komplett. **Lehre:** Single-Instance-Lock ist in Desktop-Apps mit Tray PFLICHT. |
| 72 | 2026-02-18 | **`await` in non-async Callbacks = SyntaxError** (Memory-Migration) - `await` innerhalb von non-async Callbacks (z.B. Event-Handler, Callbacks) erzeugt einen SyntaxError der das gesamte ES-Modul am Laden hindert. Lösung: `.then()` für async Operationen in non-async Callbacks verwenden. **Lehre:** ES-Module laden nicht bei SyntaxErrors — der Fehler ist subtil weil kein offensichtlicher Runtime-Error auftritt, sondern das Modul einfach nicht existiert. |
| 73 | 2026-02-18 | **Electron-Initialisierungsmuster** (Memory-Migration, Electron-Ära) - (1) Tray/Hotkey/Tags-Initialisierung MUSS in try-catch gewrappt werden, sonst kann ein Fehler die gesamte main.js zum Absturz bringen. (2) Electron preload.js erfordert `contextBridge` (funktioniert nicht mit plain Node). (3) `execSync` in Electron-Main friert die UI ein — IMMER async `execFile` verwenden. (4) `nativeImage.createFromDataURL` für Tray-Icons verwenden (createFromBuffer ist unzuverlässig). **Lehre:** Desktop-App-Initialisierung muss fehlertolerant sein — ein Fehler in einem Subsystem darf nicht die ganze App killen. |
| 82 | 2026-02-18 | **`exec()` geht durch cmd.exe → fragile Quoting** (Memory-Migration) - `exec()` / `child_process.exec()` leitet Befehle durch `cmd.exe`, was doppelte Anführungszeichen fragil macht. Verschachtelte Quotes brechen regelmässig. Lösung: IMMER `execFile()` / `execFileAsync()` verwenden, die direkt den Prozess starten ohne cmd.exe-Zwischenschicht. **Lehre:** Gilt sowohl für Node.js (Electron) als auch für Rust (`std::process::Command` mit `arg()` statt Shell-Strings). |

---

## Netzwerk

| # | Datum | Beschreibung |
|---|-------|-------------|
| 12 | 2026-02-17 | **ARP-Table Race Condition** - ARP-Tabelle wird VOR dem Ping-Sweep gelesen. Neue Geräte nach dem Ping haben keinen ARP-Eintrag. Fix: ARP-Table NACH dem Ping-Sweep nochmals lesen. |
| 13 | 2026-02-17 | **SSDP liefert 0 Modelle** - Log zeigt "0 mit Modell-Info" bei jedem Scan. Ursache: Mögliches Firewall-Blocking von SSDP-Multicast (Port 1900) oder alle Geräte im Netzwerk unterstützen kein UPnP. friendlyName wird im Frontend ignoriert. Fix: friendlyName anzeigen + vendor in deviceLabel einbauen. |
| 14 | 2026-02-17 | **OUI-Datenbank wird nie heruntergeladen** - `updateOUIDatabase()` existiert im Backend aber wird NIRGENDS im Frontend aufgerufen. Nur 200 statische OUI-Einträge statt 30.000+. Fix: Automatischer Download beim ersten Netzwerk-Scan wenn keine oui.txt vorhanden. |
| 15 | 2026-02-17 | **Firmen werden nicht angezeigt** - `getPollingData()` wird nur EINMAL aufgerufen. `resolve_ips_background()` läuft async und braucht 8-10s, aber danach wird `getPollingData()` nie wieder aufgerufen. Ergebnis: IP-Cache wird befüllt aber Frontend sieht die Daten nie. Fix: Periodisch `getPollingData()` aufrufen oder zweiten Refresh nach 10s einplanen. |
| 16 | 2026-02-17 | **classify_device() gibt nur generische Labels** - "Drucker" statt "Brother Drucker". Vendor-Info ist bekannt aber wird nicht in deviceLabel eingebaut. Fix: Vendor in Label integrieren wenn möglich. |
| 20 | 2026-02-17 | **MAC-Adressen: Passiver Scan ohne Fallback** - Im passiven Scan fehlt der `|| '—'` Fallback für leere MAC-Adressen. Ergebnis: Leere Tabellenzellen. |
| 25 | 2026-02-17 | **detect_os: Byte-Index auf lowercase String** - `ssdp_server[start..]` nutzte Index von `server_lower` → potentieller Panic bei Non-ASCII. Fix: Konsistent `server_lower` verwenden. |
| 27 | 2026-02-17 | **get_smb_shares: Falscher PowerShell-Command** - `Get-SmbConnection` zeigt nur aktive Verbindungen, nicht alle Shares auf einem Server. Fix: Fallback auf `net view \\server` wenn keine Verbindungen gefunden. |
| 31 | 2026-02-17 | **OUI-Download nie vom Frontend getriggert** - `updateOUIDatabase()` in `tauri-bridge.js` vorhanden aber nie aufgerufen. Fix: Automatischer Download bei erstem Active-Scan. Lehre: Bridge-Methoden MÜSSEN im Frontend verwendet werden. |
| 34 | 2026-02-17 | **get_connection_diff: removed immer leer** - Entfernte Verbindungen wurden nie erkannt, `removed: []` war hardcoded. Fix: Prev-Connections mit Current vergleichen, fehlende als "closed" Events melden. |
| 37 | 2026-02-17 | **get_network_summary: .Count auf null** - PowerShell `(pipeline).Count` gibt `$null` zurück wenn Pipeline leer ist. Fix: `@(pipeline).Count` erzwingt Array-Kontext, gibt immer 0 statt null. |
| 39 | 2026-02-17 | **resolve_ips: Inkonsistentes Caching** - `resolve_ips` cached nur nicht-leere Companies, `resolve_ips_background` cached auch leere. Folge: IPs ohne Company werden bei jedem Aufruf neu aufgelöst. Fix: Beide cachen konsistent (inkl. leere Strings). |
| 40 | 2026-02-17 | **get_bandwidth + get_polling_data: Race Condition** - Beide Funktionen nutzen denselben `bw_prev_store` mit demselben Adapter-Namen als Key. Bei gleichzeitigem Aufruf überschreiben sie gegenseitig die Prev-Werte → falsche Raten. Fix: Prefix `bw_` bzw. `poll_` pro Quelle. |
| 50 | 2026-02-17 | **OUI: Fehlerhafte Prefixes in statischer Tabelle** - Juniper `"0005850"` (7 Zeichen), Synology `"0011320"` (7 Zeichen), QNAP `"24:5E:BE"` (mit Doppelpunkten) — alle matchen nie, weil `lookup()` nur 6-stellige Hex-Strings vergleicht. Fix: Korrigiert auf korrekte 6-stellige Prefixes. Lehre: OUI-Prefixes sind IMMER genau 6 Hex-Zeichen, keine Sonderzeichen. |
| 51 | 2026-02-17 | **classify_device: `h.contains("tv")` zu breit** - Hostname `"entwickler-pc"` enthält "tv" (en**tv**ickler) → fälschlich als Smart-TV klassifiziert. Fix: Spezifischere Patterns (`-tv`, `tv-`, `smart-tv` etc.). Lehre: Substring-Matching auf kurze Tokens (2-3 Zeichen) erzeugt False Positives. |
| 54 | 2026-02-17 | **is_tracker: `.analytics.` und `.facebook.com/tr` zu breit** - `.analytics.` matcht auf interne Services, `.facebook.com/tr` ist ein URL-Pfad der nie in Hostnamen vorkommt. Fix: Spezifischere Patterns (`google-analytics.`, `pixel.facebook.`). |
| 56 | 2026-02-17 | **export_network_history: CSV-Felder existierten nicht** - CSV-Export griff auf `data["connections"]`, `data["bandwidthRx"]`, `data["bandwidthTx"]` zu, aber die Snapshot-Struktur ist `{ summary: { totalConnections, ... }, grouped: [...] }`. Alle CSV-Spalten waren Nullen. Fix: CSV liest jetzt `data.summary.totalConnections`, `establishedCount`, `listeningCount`, `udpCount` und Prozessanzahl aus `grouped`. Lehre: Bei Export-Funktionen immer die tatsächliche Datenstruktur prüfen, nicht raten. |
| 83 | 2026-02-18 | **Netzwerk-Scan: Port-Scan MUSS parallel sein** (Memory-Migration) - Port-Scan MUSS voll parallel sein (`ConnectAsync` + `WaitAll`), nie sequentiell pro IP. SMB-Shares MÜSSEN `RunspacePool` für Parallelismus nutzen. Sequentielles PowerShell = eingefrorene UI. **Lehre:** Netzwerk-Operationen mit potentiell vielen Zielen immer parallelisieren. |

---

## UI

| # | Datum | Beschreibung |
|---|-------|-------------|
| 3 | 2026-02-10 | **Chromium file:// blockiert Module Workers** - pdf.js Worker (.mjs) → Module Worker → Chromium blockiert von file:// URLs. Lösung: Worker per Blob-URL laden, `export{}` entfernen. Lehre: In Electron/Tauri niemals Module Workers verwenden. |
| 19 | 2026-02-17 | **SVG-Icons ohne CSS = unsichtbar** - SVG-Icons im Explorer hinzugefügt aber CSS für Grösse/Farbe muss gleichzeitig erstellt werden. Lehre: Frontend-Änderungen IMMER als Gesamtpaket (HTML + JS + CSS) testen. |
| 28 | 2026-02-17 | **Views ohne destroy() = Memory Leak** - NetworkView, PrivacyView, SmartView, SoftwareAuditView, SystemScoreView hatten keine `destroy()` Methode. Intervalle und Chart-Instanzen werden nie aufgeräumt. Fix: `destroy()` in allen Views implementieren. Lehre: JEDE View braucht `destroy()`. |
| 29 | 2026-02-17 | **preview.js escapeHtml ohne Quote-Escaping** - Lokale `escapeHtml()` hatte kein `"` → `&quot;` Escaping. Potential für XSS bei Dateinamen mit Anführungszeichen. Fix: `&quot;` Escaping ergänzt. |
| 57 | 2026-02-17 | **tabLoaded premature set = Retry blockiert** - `tabLoaded.xxx = true` VOR `await view.init()` gesetzt. Wenn der API-Call fehlschlug, blieb `tabLoaded[tab] === true` und `autoLoadTab()` prüfte `if (tabLoaded[tabName]) return;` → Tab konnte nie neu geladen werden. Fix: Flag erst NACH erfolgreichem `await` setzen. Lehre: Boolean-Flags die "wurde geladen" signalisieren MÜSSEN NACH dem Ladevorgang gesetzt werden, nicht davor. |
| 59 | 2026-02-17 | **10 Dateien mit lokaler _esc() Duplikaten** - Jede View hatte eine eigene `_esc(text)` Kopie statt die zentrale `escapeHtml()` aus utils.js zu importieren. Risiko: Bei Änderung der zentralen Funktion bleiben lokale Kopien veraltet. Fix: Systematische Bereinigung aller 10 Dateien. Lehre: Utility-Funktionen IMMER importieren, nie kopieren. Code-Duplikation ist ein Bug. |
| 60 | 2026-02-17 | **confirm() in Tauri/WebView2** - Nativ-Browser `confirm()` blockiert den Thread und zeigt einen primitiven Systemdialog statt des Tauri-Dialogs. Inkonsistente UX. Fix: `window.api.showConfirmDialog()` verwenden. Lehre: In Tauri-Apps IMMER die Tauri-Dialog-API verwenden, nicht Browser-Dialoge. |
| 63 | 2026-02-17 | **ES-Module Cascade Failure durch fehlende defensive Programmierung** - **Entstehung:** Bei der Electron→Tauri-Migration wurde `NetworkView` in `network.js` mit einem Constructor geschrieben, der direkt auf `window.api.onNetworkScanProgress` (Zeile 68) und `window.api.getPreferences` (Zeile 54) zugreift — ohne optional chaining (`?.`). Ebenso in `app.js` Zeile 152: `window.api.onOpenEmbeddedTerminal(...)` als Module-Level-Statement. Diese Zugriffe funktionierten solange `window.api` existierte. **Symptom:** Durch Lesson #62 (withGlobalTauri=false) war `window.api` undefined. Der TypeError in `network.js:68` trat auf Module-Level auf (im Constructor, der beim Import ausgeführt wird). In ES-Modulen killt ein unbehandelter Fehler auf Top-Level das GESAMTE Modul — und alle Module die davon abhängen. Da `app.js` von `network.js` importiert, starb auch `app.js`. Die Funktion `init()` lief nie → `setupSidebar()` lief nie → Burger-Menü, Tabs, Sidebar, Footer — alles tot. **Diagnose:** Error-Logger in index.html fing `TypeError: Cannot read properties of undefined (reading 'onNetworkScanProgress') @ network.js:68:24` ab. Stack-Trace zeigte: Module-Level → Constructor → _setupScanProgressListener() → `window.api.onNetworkScanProgress`. **Lösung:** Alle `window.api.*`-Zugriffe in Constructors und Module-Level-Code auf `window.api?.` (optional chaining) umgestellt: `network.js:68`, `network.js:54`, `app.js:152`. **Lehre:** In ES-Modulen ist defensive Programmierung auf Top-Level ABSOLUTE PFLICHT. Ein einziger TypeError auf Module-Level = gesamte Modul-Kette tot. JEDER `window.api`-Zugriff ausserhalb von Funktionen die erst nach vollständiger Initialisierung aufgerufen werden, MUSS `?.` verwenden. |
| 64 | 2026-02-17 | **showConfirmDialog Rückgabewert ≠ Boolean** - **Entstehung:** Beim Frontend-Audit (Commit 4759e4c) wurde `confirm()` in `network.js` durch `window.api.showConfirmDialog()` ersetzt, um den nativen Tauri-Dialog statt des primitiven Browser-Dialogs zu verwenden. Der Ersatz-Code verwendete `if (!confirmDel) return;` — in der Annahme, dass der Dialog einen Boolean zurückgibt (wie `confirm()` das tut). Tatsächlich gibt `show_confirm_dialog` in `commands.rs` (Zeile 432-457) aber `json!({ "response": if answer { 1 } else { 0 } })` zurück — ein Objekt, kein Boolean. **Symptom:** Die Lösch-Bestätigung in der Netzwerk-Aufzeichnungsliste und der Verlauf-Löschung wurde NIE blockiert. Egal ob der User "Abbrechen" klickte, die Löschung wurde trotzdem durchgeführt. Grund: `!{response: 0}` → ein Objekt ist immer truthy → `!truthy` = `false` → `if (false) return;` → nie blockiert. **Diagnose:** Code-Review von `commands.rs:show_confirm_dialog` zeigte den Return-Wert `{response: 0/1}`. Vergleich mit anderen Aufrufstellen (z.B. `explorer.js`) zeigte korrekte Verwendung: `result.response !== 1`. Nur die 2 neuen Stellen in `network.js` (Zeile 1456 und 1766) hatten den Bug. **Lösung:** `if (!confirmDel) return;` → `if (!confirmDel?.response) return;` an beiden Stellen. Das `?.` schützt zusätzlich falls der Dialog-Aufruf fehlschlägt (undefined). **Lehre:** Bei API-Migrationen (hier: `confirm()` → `showConfirmDialog()`) MUSS der Rückgabewert der neuen API geprüft werden. Nicht annehmen, dass die neue API denselben Typ zurückgibt wie die alte. Immer `commands.rs` gegenchecken. |
| 69 | 2026-02-18 | **extract-to: Falscher Dialog + fehlerhafte Return-Behandlung** - **3 Bugs:** (1) `showSaveDialog` (`app.js:1046`) ist ein Datei-Speichern-Dialog, kein Ordner-Auswahl-Dialog. (2) Backend `show_save_dialog` (`commands.rs:305`) ignoriert den `_options`-Parameter (Underscore-Prefix) — `{ directory: true }` wird nie ausgewertet. (3) `if (dest)` (`app.js:1047`) ist IMMER truthy weil `showSaveDialog` immer ein Objekt zurückgibt (`{ path: "..." }` oder `{ canceled: true }`), `dest` (das Objekt) wird statt `dest.path` an `extractArchive` übergeben. **Lösung:** Eigenen Folder-Picker-Dialog implementieren oder `show_save_dialog` um Ordner-Modus erweitern. Return-Behandlung auf `dest.canceled !== true && dest.path` umstellen. **Lehre:** Dialog-APIs haben verschiedene Modi (Datei/Ordner/Speichern/Öffnen). Underscore-Prefix (`_options`) in Rust = "ignoriert" — wenn der Parameter gebraucht wird, MUSS der Underscore entfernt werden. |
| 70 | 2026-02-18 | **Context-Menu: Zombie-Event-Listener bei Rechtsklick** - `showContextMenu()` registriert `mousedown`-Handler (Zeile 81-86) und `keydown`-Handler (Zeile 89-96) per `document.addEventListener`. Wenn `closeContextMenu()` extern aufgerufen wird (z.B. beim Öffnen eines neuen Menüs, Zeile 21), werden `activeMenu` und DOM-Element entfernt — aber die 2 Handler bleiben registriert. `menu.contains(e.target)` schlägt fehl (menu wurde entfernt), Handler versucht nochmals `closeContextMenu()` (no-op), entfernt sich dann zwar selbst — aber erst beim nächsten mousedown/keydown. Bei schnellen Rechtsklick-Sequenzen akkumulieren sich Handler. **Lösung:** `closeContextMenu()` muss aktive Handler selbst entfernen. Handler-Referenzen in Modul-Variablen speichern. **Lehre:** Cleanup-Logik darf nie ausschliesslich im Handler selbst liegen — die zentrale Cleanup-Funktion muss ALLE registrierten Listener abräumen. |
| 74 | 2026-02-18 | **CSS `:hover` nie für Layout-Änderungen verwenden** (Memory-Migration) - CSS `:hover` auf Sidebar-Elementen kann Layout-Verschiebungen auslösen die den User frustrieren (Elemente "springen" beim Überfahren). **Lehre:** Hover-Effekte nur für visuelle Hervorhebung (Farbe, Schatten), niemals für Grössen- oder Positionsänderungen. |
| 76 | 2026-02-18 | **Omnibar: Exakte Substring-Suche versagt bei Tippfehlern** (Memory-Migration) - Exakte Substring-Suche findet nichts bei Tippfehlern. Lösung: Progressive Prefix-Verkürzung — wenn der exakte String nicht matcht, schrittweise das letzte Zeichen entfernen und erneut suchen. **Lehre:** Suchfunktionen sollten fehlertolerant sein, nicht nur exakt matchen. |
| 78 | 2026-02-18 | **WCAG Kontrast-Regeln** (Memory-Migration, 4 zusammengefasste Punkte) - (1) `--text-muted` und `--text-secondary` müssen gegen die TATSÄCHLICHEN Hintergrundfarben berechnet werden, nicht nur gegen `--bg-primary`. (2) Dark Theme: `#5a5e72` auf `#222639` = 2.3:1 Kontrast → FAIL. Mindestens `#8890a8` für 4.5:1 benötigt. (3) Lila/Violett auf dunklem Navy = schlechte WAHRGENOMMENE Lesbarkeit, selbst wenn der mathematische Kontrast ausreicht (Farbton-Ähnlichkeit). `--text-primary` für Inhaltstext verwenden, nie Akzentfarben. (4) `--accent` (#6c5ce7) NUR für Rahmen/Hintergründe. `--accent-text` (#c4b5fd) für Labels. `--text-primary` für Inhaltstext (Dateinamen etc.). **Lehre:** WCAG-Konformität erfordert Prüfung gegen alle tatsächlichen Hintergrund-Kombinationen, nicht nur den primären Hintergrund. |
| 80 | 2026-02-18 | **UI-Änderungen müssen sichtbar sein** (Memory-Migration) - UI-Änderungen die nur per Tastenkombination erreichbar sind, werden von den meisten Nutzern nie entdeckt. Neue Funktionen MÜSSEN sichtbare Buttons, Tabs oder Menüeinträge haben — nicht nur Keyboard-Shortcuts. **Lehre:** Discoverability > Shortcuts. |
| 81 | 2026-02-18 | **Smart Reload Pattern (F5)** (Memory-Migration, Electron-Ära) - F5 muss "Smart Reload" ausführen: sessionStorage-State speichern + `location.reload()` → CSS/JS-Änderungen werden geladen UND Scan-Daten bleiben erhalten. NIEMALS `role:'reload'` direkt verwenden. Ein reiner Daten-Refresh OHNE Seitenreload lädt CSS/JS-Änderungen NICHT — der User sieht die alte UI. **Lehre:** Bei Desktop-Apps mit State: Reload muss State-Persistenz UND Asset-Neuladung kombinieren. |
| 84 | 2026-02-18 | **Electron Tray-Fenster: Win32 ShowWindow für Wiederherstellung** (Memory-Migration, Electron-Ära) - `Target.activateTarget` (CDP) reicht NICHT um ein minimiertes Fenster wiederherzustellen. Lösung: PowerShell + Win32 `ShowWindow(hWnd, 9)` (SW_RESTORE) + `SetForegroundWindow(hWnd)`. Script: `tools/wcag/restore-window.ps1`. **Lehre:** Browser-DevTools-APIs haben keine Kontrolle über Window-Manager-State. Für Desktop-Apps Windows-APIs verwenden. |

---

## Terminal

| # | Datum | Beschreibung |
|---|-------|-------------|
| 1 | 2026-02-10 | **node-pty + Electron: Native Module Builds** - node-pty@1.1.0 brauchte winpty (GetCommitHash.bat Fehler). node-pty@1.2.0-beta.11 (ConPTY-only) scheiterte an Spectre-Mitigation. Lösung: `scripts/rebuild-pty.js` patcht binding.gyp automatisch vor electron-rebuild. Lehre: Native Electron-Module können plattformspezifische Build-Probleme haben. |
| 9 | 2026-02-17 | **Terminal Piped I/O: Kein PTY = kein interaktives Terminal** - `std::process::Command` mit `Stdio::piped()` ist KEIN PTY. Backspace, Umlaute, Pfeiltasten, Tab-Completion funktionieren NICHT. PowerShell hat kein PSReadLine im Non-PTY-Modus. Lösung: `portable-pty` Crate für ConPTY. Quick-Fix: UTF-8 Encoding per stdin + Input-Buffer im Frontend. |
| 10 | 2026-02-17 | **Windows PowerShell Encoding: cp437/cp850 statt UTF-8** - Terminal startet PowerShell ohne UTF-8-Encoding-Initialisierung. `from_utf8_lossy()` liest cp850-Bytes → Umlaute kaputt. Fix: `[Console]::OutputEncoding = [Text.Encoding]::UTF8` per stdin nach Spawn senden. CMD: `chcp 65001`. |
| 11 | 2026-02-17 | **Set-Location sichtbar im Terminal** - `changeCwd()` sendet rohen `Set-Location`-Befehl an stdin. In Non-PTY-Modus kein sauberer Prompt. Fix: Terminal bei cwd-Wechsel neu starten statt Set-Location senden. |
| 32 | 2026-02-17 | **terminal_open_external ohne Fallback** - Nur Windows Terminal (`wt`) unterstützt. Wenn nicht installiert → Fehler. Fix: Fallback auf `cmd.exe /k cd /d`. |
| 47 | 2026-02-17 | **Git Bash: Hardcoded Pfad** - `C:\Program Files\Git\bin\bash.exe` fester Pfad. Fix: `find_git_bash()` sucht dynamisch via `where git` und leitet den bash.exe-Pfad ab. Fallback auf bekannte Installationspfade. |
| 77 | 2026-02-18 | **PowerShell Kaltstart: 5-10+ Sekunden** (Memory-Migration) - PowerShell-Erststart ("Cold Start") dauert 5-10+ Sekunden. Timeouts unter 15 Sekunden für PowerShell-Commands führen zu sporadischen Fehlschlägen. Ausserdem: Mehrere parallele PowerShell-Prozesse können sich gegenseitig aushungern (CPU/RAM). Lösung: Mindestens 15-30s Timeout für PS-Commands. Parallele PS-Prozesse wenn möglich sequentiell ausführen. **Lehre:** PowerShell ist langsam — Timeouts und Parallelität entsprechend planen. |
| 79 | 2026-02-18 | **PowerShell Multi-Line: .replace(/\\n/g) zerstört Statements** (Memory-Migration) - PowerShell-Scripts mit mehreren Zeilen: NIEMALS `.replace(/\n/g, ' ')` verwenden — das zerstört Statement-Grenzen (z.B. if/else-Blöcke, Pipeline-Fortsetzungen). Lösung: `.trim()` und mit Zeilenumbrüchen übergeben (`execFileAsync` verarbeitet sie korrekt). Dazu: IMMER `runPS()` / `run_ps()` für PowerShell verwenden (30s Timeout + UTF-8 Prefix), nie rohe `execFile('powershell.exe', ...)` mit niedrigem Timeout. **Lehre:** PowerShell-Statements sind zeilenorientiert — Zeilenumbrüche sind syntaktisch relevant. |

---

## Security

| # | Datum | Beschreibung |
|---|-------|-------------|
| 21 | 2026-02-17 | **withGlobalTauri: true = Sicherheitslücke** - `tauri.conf.json` hatte `withGlobalTauri: true`. Das erlaubt eingeschleustem JS-Code direkten Zugriff auf `window.__TAURI__` IPC. Fix: Auf `false` setzen, Zugriff nur über `tauri-bridge.js`. |
| 22 | 2026-02-17 | **Context-Menu Event-Name Mismatch** - Backend emittiert `context-menu-request`, Bridge hört auf `context-menu-action`. Kontextmenü funktioniert nie. Fix: Event-Namen synchronisieren. Lehre: Bei IPC-Events IMMER beide Seiten prüfen. |
| 23 | 2026-02-17 | **Privacy-Settings: REG_DWORD statt REG_SZ** - `CapabilityAccessManager\ConsentStore` (app-diagnose, standort-zugriff) speichert "Allow"/"Deny" als REG_SZ-String. Code schrieb REG_DWORD 0/1 → Wert wird ignoriert, Einstellung bleibt unverändert. Fix: REG_SZ mit korrekten String-Werten. |
| 26 | 2026-02-17 | **resolve_ips: Keine IP-Validierung** - IPs vom Frontend wurden unvalidiert in PowerShell-Befehle eingesetzt → Command-Injection-Risiko. Fix: `validate_ip()` vor Verwendung aufrufen. |
| 41 | 2026-02-17 | **disable_scheduled_task: Wildcard `-TaskName '*'`** - Deaktiviert ALLE Tasks in einem Pfad statt nur einen einzelnen. Könnte kritische System-Tasks abschalten. Fix: `task_name` Parameter obligatorisch, Wildcard verboten. Frontend sendet jetzt `path` und `name` getrennt. |
| 43 | 2026-02-17 | **open_with_dialog: Double-Quote nicht escaped** - Dateinamen mit `"` in PowerShell-Argument könnten Shell-Injection ermöglichen. Fix: `"` → `` `" `` (PowerShell-Escape). Lehre: Einfache UND doppelte Anführungszeichen escapen. |
| 58 | 2026-02-17 | **preview.js: Lokale escapeHtml() ohne Quote-Escaping** - Die lokale `escapeHtml()` in preview.js escaped nur `&<>"` aber NICHT `'`. Die zentrale Version in utils.js escaped auch Single-Quotes. In Attribut-Kontexten (z.B. `title='${escapeHtml(...)}'`) wäre ein XSS möglich. Fix: Importierte Funktion aus utils.js verwenden. Lehre: EINE zentrale Escape-Funktion, keine lokalen Varianten. |
| 62 | 2026-02-17 | **withGlobalTauri=false killt gesamtes Frontend** - **Entstehung:** Während des Tiefenaudits (Commit b8a7da1, "18+ Bugs gefixt") wurde `withGlobalTauri` in `tauri.conf.json` von `true` auf `false` gesetzt. Die Annahme war, dass `false` sicherer sei, weil es den direkten Zugriff auf `window.__TAURI__` durch eingeschleusten Code verhindert. Diese Annahme war falsch — der vollständige Datenfluss wurde nicht geprüft. **Symptom:** Simon meldete "Das Burger-Menü ist defekt!". Tatsächlich war die GESAMTE App tot — kein Sidebar-Toggle, keine Tabs, keine Daten, keine Funktionen. Im Dev-Log erschienen NULL Frontend-API-Aufrufe (keine PowerShell-Calls für Laufwerke, Ordner, Scan-Daten). **Diagnose:** (1) Vergleich der Dev-Logs: Arbeitende Session (11:28) zeigte sofort PowerShell-Calls, kaputte Session zeigte nichts. (2) Temporärer Error-Logger in index.html über `__TAURI_INTERNALS__` fing den Fehler ab: `Uncaught TypeError: Cannot read properties of undefined (reading 'onNetworkScanProgress') @ network.js:68:24`. (3) Rückverfolgung: `window.api` war `undefined` → Bridge-IIFE in `tauri-bridge.js` Zeile 7 prüft `if (!window.__TAURI__ || window.api) return;` → mit `withGlobalTauri: false` existiert `window.__TAURI__` nicht → Bridge bricht ab → `window.api` wird nie erstellt. **Lösung:** `withGlobalTauri` zurück auf `true`. Die Zugriffskontrolle in Tauri v2 erfolgt über das Capability-System (`capabilities/default.json`), NICHT durch Verstecken von `window.__TAURI__`. CLAUDE.md-Regel korrigiert. **Lehre:** Security-Fixes MÜSSEN den vollständigen Datenfluss prüfen (Frontend → Bridge → Tauri-API → Backend). Eine "sichere" Einstellung die die gesamte App zerstört ist kein Security-Fix — es ist ein kritischer Bug. |

---

## Performance

| # | Datum | Beschreibung |
|---|-------|-------------|
| 36 | 2026-02-17 | **Blockierende I/O in async Funktionen** - `std::fs::write`, `std::fs::OpenOptions`, `std::fs::read_dir` in async `#[tauri::command]` blockieren den Tokio-Runtime-Thread. Fix: `tokio::fs` + `tokio::task::spawn_blocking`. Lehre: In async Commands IMMER `tokio::fs` statt `std::fs` verwenden. |
| 38 | 2026-02-17 | **list_network_recordings: Gesamte Datei gelesen** - `read_to_string` lud komplette Aufzeichnungsdateien in RAM nur für Header/Footer. Fix: `BufReader` liest nur erste und letzte Zeile, Fallback mit Line-Count nur wenn kein Footer. |
| 44 | 2026-02-17 | **terminal_destroy: child.wait() blockiert Tokio** - `std::sync::Mutex::lock()` + `child.kill()` + `child.wait()` blockieren den async Runtime-Thread. Fix: Mutex sofort droppen, kill+wait in `spawn_blocking`. |
| 75 | 2026-02-18 | **CSS/Chart.js Animationen = CPU/GPU-Last** (Memory-Migration) - CSS `animation: infinite` verbraucht GPU/CPU-Ressourcen selbst wenn das Element `display:none` hat. Chart.js Standard-Animationen erzeugen unnötige CPU-Last bei jedem Daten-Update. Lösung: CSS-Animationen bewusst nur wenn sichtbar aktivieren. Chart.js: IMMER `animation: false` in der Config setzen. **Lehre:** Animationen in Desktop-Apps sparsam einsetzen — sie verbrauchen dauerhaft Ressourcen. |

---

## Migration

| # | Datum | Beschreibung |
|---|-------|-------------|
| 6 | 2026-02-16 | **Migration = JEDE Funktion prüfen** - 31 Funktionen als Stubs belassen nach Electron→Tauri v2 Migration. Lehre: Per Grep nach `stub: true`, `json!([])`, `json!(null)` suchen. Migration ist NICHT fertig wenn die App startet — erst wenn JEDE Funktion echte Daten liefert. |
| 8 | 2026-02-17 | **Base64-Dekodierung für Tauri-IPC** - Tauri serialisiert Binärdaten als Base64-JSON-Strings. Electron konnte ArrayBuffers direkt übergeben. `new Uint8Array(base64String)` ergibt leeres Array. Fix: `atob()` + charCode-Schleife. Lehre: Jeder Datentyp-Transfer zwischen Rust↔JS muss einzeln verifiziert werden. |

---

## Privacy

| # | Datum | Beschreibung |
|---|-------|-------------|
| 55 | 2026-02-17 | **diagnose-toast: recommendedValue Widerspruch** - `build_privacy_settings` definierte `recommendedValue: 0`, aber `privacy_setting_lookup` hatte `recommended: 1`. Nach Anwenden schrieb `apply_privacy_setting` den Wert `1`, aber die Anzeige prüfte gegen `0` → UI zeigte dauerhaft "nicht privat". Fix: `recommendedValue` auf `1` geändert. Lehre: Wenn dieselbe Einstellung an zwei Stellen definiert wird (Anzeige vs Logik), MÜSSEN die Werte übereinstimmen. |
